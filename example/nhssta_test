#!/bin/sh

NHSSTA=../src/nhssta

# Track overall success
TOTAL_TESTS=0
PASSED_TESTS=0
FAILED_TESTS=0

# Function to print section header
print_section() {
    echo ""
    echo "=========================================="
    echo "$1"
    echo "=========================================="
}

# Function to print success
print_success() {
    echo "✓ $1"
}

# Function to print failure
print_failure() {
    echo "✗ $1"
}

# Function to run a single test
run_test() {
    TEST_NAME="$1"
    DLIB_FILE="$2"
    BENCH_FILE="$3"
    OPTIONS="$4"
    RESULT_FILE="$5"
    TEMP_RESULT_FILE="${RESULT_FILE}_"

    TOTAL_TESTS=$((TOTAL_TESTS + 1))
    echo "Test ${TOTAL_TESTS}: ${TEST_NAME} (${OPTIONS})"

    rm -f "${TEMP_RESULT_FILE}"

    # Run nhssta, filter comments, version, timestamp, and OK line, and save output
    if ! ${NHSSTA} ${OPTIONS} -d "${DLIB_FILE}" -b "${BENCH_FILE}" 2>&1 | grep -v "^#" | grep -v "nhssta 0.0.8" | grep -v "^OK$" > "${TEMP_RESULT_FILE}"; then
        print_failure "  FAILED (nhssta execution failed)"
        FAILED_TESTS=$((FAILED_TESTS + 1))
        return 1
    fi

    # Compare with expected result, ignoring version and timestamp lines
    if diff -q -I "nhssta 0.0.8" "${TEMP_RESULT_FILE}" "${RESULT_FILE}" >/dev/null 2>&1; then
        print_success "  PASSED"
        PASSED_TESTS=$((PASSED_TESTS + 1))
        rm -f "${TEMP_RESULT_FILE}" # Clean up on success
    else
        print_failure "  FAILED"
        echo "    --- Diff for ${TEST_NAME} ---"
        diff -u -I "nhssta 0.0.8" "${TEMP_RESULT_FILE}" "${RESULT_FILE}"
        echo "    -----------------------------"
        FAILED_TESTS=$((FAILED_TESTS + 1))
    fi
    return 0
}

print_section "Running nhssta integration tests"

# Test cases
run_test "my.dlib + my.bench" "my.dlib" "my.bench" "-l -c" "result1"
run_test "ex4_gauss.dlib + ex4.bench" "ex4_gauss.dlib" "ex4.bench" "-l -c" "result2"
run_test "ex4_gauss.dlib + s27.bench" "ex4_gauss.dlib" "s27.bench" "-l -c" "result3"
run_test "gaussdelay.dlib + s298.bench" "gaussdelay.dlib" "s298.bench" "-l" "result4"
run_test "gaussdelay.dlib + s344.bench" "gaussdelay.dlib" "s344.bench" "-l" "result5"
run_test "gaussdelay.dlib + s820.bench" "gaussdelay.dlib" "s820.bench" "-l" "result6"
run_test "ex4_gauss.dlib + ex3.bench" "ex4_gauss.dlib" "ex3.bench" "-l -c" "result7"
run_test "dos.dlib + dos.bench" "dos.dlib" "dos.bench" "-l -c" "result8"

print_section "Test Summary"
echo "Total tests: ${TOTAL_TESTS}"
echo "Passed: ${PASSED_TESTS}"
echo "Failed: ${FAILED_TESTS}"
echo ""

if [ ${FAILED_TESTS} -eq 0 ]; then
    print_success "All tests passed!"
    exit 0
else
    print_failure "Some tests failed. See output above for details."
    exit 1
fi
