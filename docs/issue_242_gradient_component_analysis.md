# Issue #242: 勾配成分の分析 - どちらが負か？

## 質問

`(∂MAX0/∂diff) × (∂MAX(A,B)/∂B)` の計算で、どちらが負なのか？

## 回答

**`upstream = -11.199` が負です。** これは `∂MAX0/∂diff` ではなく、**MAX0に流れ込むupstream勾配**です。

## 重要な区別

### 1. upstream勾配（MAX0に流れ込む）

```
upstream = ∂MAX(MAX(A,B), MAX(A,C))/∂MAX0(diff)
```

これは、MAX0の**出力側から流れ込む勾配**です。

### 2. MAX0の入力に対する勾配

```
grad[0] = ∂MAX0/∂diff
```

これは、MAX0の**入力（diff）に対する勾配**です。

## デバッグログからの証拠

```
arg[0]: upstream=-11.199 × grad[0]=0.792892 = contrib=-8.87958
```

ここで：
- `upstream = -11.199` (**負!**)
- `grad[0] = 0.792892` (正)
- `contrib = upstream × grad[0] = -8.87958` (負)

## 分析

### 理論的期待

```
MAX(MAX(A,B), MAX(A,C)) = MAX(A,C) + MAX0(MAX(A,B) - MAX(A,C))
```

したがって：
```
∂MAX/∂MAX0(diff) = 1 (正であるべき!)
```

### 実際の動作

しかし、デバッグログでは `upstream = -11.199` (負) が観察されています。

## なぜupstreamが負になるのか？

### 仮説1: 式木の構造が複雑

MAXの実装では、正規化が行われます：
```cpp
if (a->mean() >= b->mean()) {
    return MAX(a, b);  // = a + MAX0(b-a)
} else {
    return MAX(b, a);  // = b + MAX0(a-b)
}
```

多段MAX演算では、この正規化が複数回適用され、式木の構造が複雑になります。

### 仮説2: 勾配の伝播パスが複数

`MAX(MAX(A,B), MAX(A,C))` では：
- Aが複数のパスを通る
- 各パスから勾配が累積される
- 負の勾配が累積され、upstreamが負になる

### 仮説3: MINUS演算による負の勾配

式木の中に `MAX(A,B) - MAX(A,C)` のようなMINUS演算があり、これが負の勾配を生成している可能性があります。

## 結論

1. **`∂MAX0/∂diff` (grad[0]) = 0.792892**: 正（理論通り）
2. **`∂MAX(A,B)/∂B`**: 正（理論通り）
3. **`upstream = -11.199`**: **負（これが問題!）**

**問題の本質**: `upstream`が負になることが問題です。これは、MAX0の勾配計算自体ではなく、**MAX0に流れ込むupstream勾配の計算**に問題があることを示唆しています。

## 次のステップ

1. **upstreamが負になる原因の特定**: どのノードで負のupstreamが生成されているか
2. **式木の構造の検証**: MAXの正規化が勾配の伝播にどのような影響を与えているか
3. **修正案の検討**: upstreamが負にならないようにする方法

