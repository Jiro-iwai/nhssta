# Issue #188: Expression ノード数の現状まとめ

## 最適化後のノード数（s27.bench）

### `expected_prod_pos_expr()` の内訳（1回の呼び出しで75ノード）

| ステップ | ノード数 | 説明 | 最適化前 | 削減 |
|---------|---------|------|---------|------|
| a0, a1 | 2 | `mu0 / sigma0`, `mu1 / sigma1` | 2 | 0 |
| one_minus_rho2, sqrt | 4 | `1 - rho²`, `√(1-ρ²)` | 4 | 0 |
| Phi2_expr() | 1 | `Φ₂(a0, a1; ρ)` | 1 | 0 |
| phi_expr() | 14 | `φ(a0)`, `φ(a1)` (2回呼び出し) | 14 | 0 |
| Phi_expr(cond) | 20 | `Φ((a0 - ρa1)/√(1-ρ²))`, `Φ((a1 - ρa0)/√(1-ρ²))` (2回呼び出し) | 20 | 0 |
| phi2_expr() | 18 | `φ₂(a0, a1; ρ)` | 22 | **-4** |
| term1 | 2 | `μ0 μ1 Φ₂(a0, a1; ρ)` | 2 | 0 |
| term2 | 3 | `μ0 σ1 φ(a1) Φ((a0 - ρa1)/√(1-ρ²))` | 3 | 0 |
| term3 | 3 | `μ1 σ0 φ(a0) Φ((a1 - ρa0)/√(1-ρ²))` | 3 | 0 |
| term4 | 5 | `σ0 σ1 [ρ Φ₂(a0, a1; ρ) + (1-ρ²) φ₂(a0, a1; ρ)]` | 5 | 0 |
| result (sum) | 3 | `term1 + term2 + term3 + term4` | 3 | 0 |
| **合計** | **75** | | **79** | **-4** |

### `phi2_expr()` の内訳（1回の呼び出しで18ノード）

| ステップ | ノード数 | 説明 | 最適化前 | 削減 |
|---------|---------|------|---------|------|
| one_minus_rho2, sqrt | 0 | `1 - rho²`, `√(1-ρ²)` (引数として受け取る) | 4 | **-4** |
| coeff | 4 | `1/(2π√(1-ρ²))` | 4 | 0 |
| Q | 9 | `(x² - 2ρxy + y²)/(1-ρ²)` | 9 | 0 |
| result (coeff * exp) | 5 | `coeff * exp(-Q/2)` | 5 | 0 |
| **合計** | **18** | | **22** | **-4** |

### `phi_expr()` の内訳（1回の呼び出しで7ノード）

| ステップ | ノード数 | 説明 |
|---------|---------|------|
| x * x | 1 | MUL |
| (x * x) / 2.0 | 1 | DIV |
| -(x * x) / 2.0 | 1 | MINUS |
| exp(-(x * x) / 2.0) | 1 | EXP |
| INV_SQRT_2PI * exp(...) | 1 | MUL |
| **合計** | **7** | |

**キャッシュ統計**（s27.bench）:
- hits: 6
- misses: 60
- キャッシュヒット率: 9.1%

### `Phi_expr()` の内訳（1回の呼び出しで7ノード）

| ステップ | ノード数 | 説明 |
|---------|---------|------|
| x * INV_SQRT_2 | 1 | MUL |
| erf(x * INV_SQRT_2) | 1 | ERF |
| 1.0 + erf(...) | 1 | PLUS |
| 0.5 * (1.0 + erf(...)) | 1 | MUL |
| **合計** | **7** | |

**キャッシュ統計**（s27.bench）:
- hits: 6
- misses: 172
- キャッシュヒット率: 3.4%

### `Phi2_expr()` の内訳（1回の呼び出しで1ノード）

| ステップ | ノード数 | 説明 |
|---------|---------|------|
| ExpressionImpl::PHI2 | 1 | 特殊なノードタイプ |
| **合計** | **1** | |

**キャッシュ統計**（s27.bench）:
- hits: 0
- misses: 12
- キャッシュヒット率: 0%

## 全体の統計（s27.bench）

### `expected_prod_pos_expr()` の呼び出し統計

| 項目 | 値 |
|------|-----|
| 呼び出し回数 | 12回 |
| キャッシュヒット | 0回 |
| キャッシュミス | 12回 |
| キャッシュヒット率 | 0% |
| 1回あたりのノード数 | 75ノード |
| 合計ノード数 | 900ノード（75 × 12） |

### 各関数のキャッシュ統計

| 関数 | 呼び出し回数 | キャッシュヒット | キャッシュミス | キャッシュヒット率 |
|------|------------|----------------|---------------|------------------|
| `expected_prod_pos_expr()` | 12 | 0 | 12 | 0% |
| `phi_expr()` | 66 | 6 | 60 | 9.1% |
| `Phi_expr()` | 178 | 6 | 172 | 3.4% |
| `phi2_expr()` | 12 | 0 | 12 | 0% |
| `Phi2_expr()` | 12 | 0 | 12 | 0% |

## 最適化の効果

### 実装済みの最適化

1. **`phi2_expr()` の共通部分式の再利用**
   - `one_minus_rho2` と `sqrt_one_minus_rho2` を引数として受け取る
   - 効果: 4ノード削減（`phi2_expr()` 1回あたり）
   - 合計削減: 48ノード（12回呼び出し × 4ノード）

2. **`phi_expr()` と `Phi_expr()` のキャッシュ**
   - inline 関数から通常の関数に変更し、キャッシュを追加
   - 効果: 2回目の呼び出しで0ノード（キャッシュヒット）
   - ただし、異なる Expression オブジェクトで呼び出されているため、完全には効いていない

### 今後の最適化の余地

1. **`expected_prod_pos_expr()` の値ベースキャッシュ**
   - Expression オブジェクトのポインタベースのキャッシュでは、異なる Expression オブジェクト（同じ値）でキャッシュが効かない
   - 効果: 最大900ノード削減（12回呼び出し × 75ノード）

2. **`phi_expr()` と `Phi_expr()` の値ベースキャッシュ**
   - 異なる Expression オブジェクト（同じ値）でキャッシュが効くようにする
   - 効果: 最大462ノード削減（66回呼び出し × 7ノード）

3. **`Phi2_expr()` と `phi2_expr()` の値ベースキャッシュ**
   - 異なる Expression オブジェクト（同じ値）でキャッシュが効くようにする
   - 効果: 最大228ノード削減（12回呼び出し × 19ノード）

## ノード数の内訳（`expected_prod_pos_expr()` 1回あたり）

```
a0, a1:                   2 nodes
one_minus_rho2, sqrt:     4 nodes
Phi2_expr():              1 node
phi_expr() (2回):        14 nodes
Phi_expr() (2回):        20 nodes
phi2_expr():             18 nodes
term1:                    2 nodes
term2:                    3 nodes
term3:                    3 nodes
term4:                    5 nodes
result (sum):             3 nodes
─────────────────────────────
合計:                     75 nodes
```

## 参考

- 最適化前のノード数: 79ノード
- 最適化後のノード数: 75ノード
- 削減率: 5.1%

