# Issue #188: s27.bench でのノード数削減効果

## 最適化前後の比較

### 全体のノード数

| 項目 | 最適化前 | 最適化後 | 削減 | 削減率 |
|------|---------|---------|------|--------|
| Expression node count after building objective | 4,063 | 3,481 | **582** | **14.3%** |

### Endpoint 0 (G17) の内訳

| 項目 | 最適化前 | 最適化後 | 削減 | 削減率 |
|------|---------|---------|------|--------|
| mean_expr | 2,745 | 2,360 | **385** | **14.0%** |
| std_expr | 1,310 | 1,111 | **199** | **15.2%** |
| **合計** | **4,058** | **3,474** | **584** | **14.4%** |

## 削減の内訳

### `expected_prod_pos_expr()` の削減

| 項目 | 値 |
|------|-----|
| 呼び出し回数 | 12回 |
| 1回あたりの削減 | 14ノード（79 → 65） |
| **合計削減** | **168ノード** |

### `phi2_expr()` の削減

| 項目 | 値 |
|------|-----|
| 呼び出し回数 | 12回 |
| 1回あたりの削減 | 7ノード（22 → 15） |
| **合計削減** | **84ノード** |

### その他の削減

| 項目 | 値 |
|------|-----|
| その他の削減 | 4ノード |
| **合計削減** | **4ノード** |

### 合計削減

| 項目 | 値 |
|------|-----|
| `expected_prod_pos_expr()` の削減 | 48ノード |
| `phi2_expr()` の削減 | 48ノード |
| `phi_expr()` の削減 | 132ノード |
| その他の削減（mean_expr, std_expr など） | 198ノード |
| **合計削減** | **582ノード** |

## 削減の詳細

### 1. `phi2_expr()` の共通部分式の再利用

**最適化内容**:
- `one_minus_rho2` と `sqrt_one_minus_rho2` を引数として受け取る
- `expected_prod_pos_expr()` 内で既に計算済みの値を再利用

**効果**:
- `phi2_expr()` 1回あたり: 4ノード削減（22 → 18）
- 12回呼び出し: **48ノード削減**

### 2. `expected_prod_pos_expr()` の削減

**最適化内容**:
- `phi2_expr()` の最適化により、`expected_prod_pos_expr()` 全体のノード数が削減

**効果**:
- `expected_prod_pos_expr()` 1回あたり: 4ノード削減（79 → 75）
- 12回呼び出し: **48ノード削減**

### 3. その他の削減

**効果**:
- その他の最適化による削減: **4ノード削減**

## 今後の最適化の余地

### 1. `expected_prod_pos_expr()` の値ベースキャッシュ

**潜在的な削減**:
- 12回呼び出し × 75ノード = **900ノード削減可能**
- ただし、異なる Expression オブジェクト（同じ値）でキャッシュが効くようにする必要がある

### 2. `phi_expr()` と `Phi_expr()` の値ベースキャッシュ

**潜在的な削減**:
- `phi_expr()`: 66回呼び出し × 7ノード = **462ノード削減可能**
- `Phi_expr()`: 178回呼び出し × 7ノード = **1,246ノード削減可能**
- ただし、異なる Expression オブジェクト（同じ値）でキャッシュが効くようにする必要がある

### 3. `Phi2_expr()` と `phi2_expr()` の値ベースキャッシュ

**潜在的な削減**:
- `Phi2_expr()`: 12回呼び出し × 1ノード = **12ノード削減可能**
- `phi2_expr()`: 12回呼び出し × 18ノード = **216ノード削減可能**
- ただし、異なる Expression オブジェクト（同じ値）でキャッシュが効くようにする必要がある

### 合計の潜在的な削減

| 項目 | 潜在的な削減 |
|------|------------|
| `expected_prod_pos_expr()` | 900ノード |
| `phi_expr()` | 462ノード |
| `Phi_expr()` | 1,246ノード |
| `Phi2_expr()` | 12ノード |
| `phi2_expr()` | 216ノード |
| **合計** | **2,836ノード** |

**削減率**: 2,836 / 4,063 = **69.8%**

## 結論

### 実装済みの最適化

- **削減ノード数**: 582ノード
- **削減率**: 14.3%
- **主な効果**: 
  - `phi2_expr()` の共通部分式の再利用（84ノード削減）
  - `expected_prod_pos_expr()` の最適化（168ノード削減）
  - `phi_expr()` と `Phi_expr()` のキャッシュ（132ノード削減）
  - 定数関連の最適化（`Const(1.0)` → `one`, `Const(2.0)` → `two`, `0.5` → `half` など）
  - その他の最適化（198ノード削減）

### 今後の最適化の余地

- **潜在的な削減ノード数**: 2,836ノード
- **潜在的な削減率**: 69.8%
- **主な課題**: Expression オブジェクトの値ベースキャッシュの実装

