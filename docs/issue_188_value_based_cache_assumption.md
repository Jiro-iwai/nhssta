# Issue #188: 値ベースキャッシュの削減見積もりの根拠と仮定

## 問題点

「値ベースキャッシュを実装することで、さらに最大2,836ノード（69.8%）の削減が可能です。」という記述について、その根拠と仮定を明確にする必要があります。

## 現在の計算根拠

### 計算式

| 関数 | 呼び出し回数 | 1回あたりのノード数 | 潜在的な削減 |
|------|------------|-------------------|------------|
| `expected_prod_pos_expr()` | 12回 | 75ノード | 900ノード |
| `phi_expr()` | 66回 | 7ノード | 462ノード |
| `Phi_expr()` | 178回 | 7ノード | 1,246ノード |
| `Phi2_expr()` | 12回 | 1ノード | 12ノード |
| `phi2_expr()` | 12回 | 18ノード | 216ノード |
| **合計** | | | **2,836ノード** |

**削減率**: 2,836 / 4,063 = **69.8%**

## 問題点

### 1. 過度に楽観的な仮定

この計算は、**値ベースキャッシュが実装された場合、全ての呼び出しがキャッシュヒットする**と仮定しています。しかし、実際には：

- **異なる Expression オブジェクトでも同じ値を持つ場合にのみキャッシュが効く**
- 実際の呼び出しパターンでは、同じ値を持つ Expression がどれくらいあるかは不明
- 全ての呼び出しがキャッシュヒットするとは限らない

### 2. ノード数の不一致

- **`expected_prod_pos_expr()`**: ドキュメントでは75ノードと記載されているが、実際の測定では65ノード（最適化後）
- **`phi2_expr()`**: ドキュメントでは18ノードと記載されているが、実際の測定では15ノード（最適化後）

### 3. 呼び出し回数の根拠が不明確

- `phi_expr()`: 66回呼び出し
- `Phi_expr()`: 178回呼び出し

これらの呼び出し回数がどこから来たのか、実際の測定結果と一致するか確認が必要です。

## 実際の測定結果（最適化後）

### `expected_prod_pos_expr()`

- **呼び出し回数**: 12回（確認済み）
- **1回あたりのノード数**: 65ノード（最適化後）
- **合計ノード数**: 12 × 65 = 780ノード

### `phi2_expr()`

- **呼び出し回数**: 12回（`expected_prod_pos_expr()` 内で呼び出される）
- **1回あたりのノード数**: 15ノード（最適化後）
- **合計ノード数**: 12 × 15 = 180ノード

### `phi_expr()` と `Phi_expr()`

- 実際の呼び出し回数とノード数を確認する必要がある

## より現実的な見積もり

### 仮定の修正

値ベースキャッシュが実装された場合、以下のような仮定がより現実的です：

1. **完全なキャッシュヒットは期待できない**
   - 異なる Expression オブジェクトでも同じ値を持つ場合にのみキャッシュが効く
   - 実際の呼び出しパターンでは、同じ値を持つ Expression の割合は不明

2. **キャッシュヒット率の推定**
   - 楽観的: 50%の呼び出しがキャッシュヒット
   - 現実的: 20-30%の呼び出しがキャッシュヒット
   - 悲観的: 10%以下の呼び出しがキャッシュヒット

### 修正された見積もり

**楽観的な場合（50%キャッシュヒット）**:
- `expected_prod_pos_expr()`: 12回 × 65ノード × 50% = 390ノード削減
- `phi2_expr()`: 12回 × 15ノード × 50% = 90ノード削減
- `phi_expr()`: 66回 × 12ノード × 50% = 396ノード削減（仮定）
- `Phi_expr()`: 178回 × 16ノード × 50% = 1,424ノード削減（仮定）
- **合計**: 約2,300ノード削減（**56.6%削減**）

**現実的な場合（25%キャッシュヒット）**:
- `expected_prod_pos_expr()`: 12回 × 65ノード × 25% = 195ノード削減
- `phi2_expr()`: 12回 × 15ノード × 25% = 45ノード削減
- `phi_expr()`: 66回 × 12ノード × 25% = 198ノード削減（仮定）
- `Phi_expr()`: 178回 × 16ノード × 25% = 712ノード削減（仮定）
- **合計**: 約1,150ノード削減（**28.3%削減**）

## 推奨される修正

### 1. ドキュメントの修正

「値ベースキャッシュを実装することで、さらに最大2,836ノード（69.8%）の削減が可能です。」という記述を以下のように修正：

**修正案**:
「値ベースキャッシュを実装することで、理論上は最大2,836ノード（69.8%）の削減が可能ですが、これは**全ての呼び出しがキャッシュヒットする**という過度に楽観的な仮定に基づいています。実際の削減効果は、同じ値を持つ Expression の割合に依存し、現実的には20-50%の削減（約580-1,450ノード）が期待されます。」

### 2. 仮定の明確化

値ベースキャッシュの削減見積もりには、以下の仮定が含まれていることを明記：

1. **全ての呼び出しがキャッシュヒットする**（過度に楽観的）
2. **異なる Expression オブジェクトでも同じ値を持つ場合にキャッシュが効く**
3. **Expression の値ベースの比較が実装可能**（構造比較が必要）

### 3. 実際の測定結果との整合性

- 実際の測定結果（最適化後のノード数）と一致するように数値を更新
- 呼び出し回数の根拠を明確にする

## 結論

「値ベースキャッシュを実装することで、さらに最大2,836ノード（69.8%）の削減が可能です。」という記述は、**過度に楽観的な仮定**に基づいています。より現実的な見積もりでは、**20-50%の削減（約580-1,450ノード）**が期待されます。

