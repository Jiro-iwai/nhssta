# Issue #242: モンテカルロ法による検証結果

## 概要

モンテカルロ法（厳密解）を使用して、`MAX(MAX(A,B), MAX(A,C))` の期待値と感度解析を計算し、Clark近似の実装結果と比較しました。

## 検証方法

### モンテカルロ法

- **サンプル数**: 1,000,000
- **有限差分法**: Common Random Number法を使用して勾配を計算
- **テストケース**: 
  - A ~ N(10.0, 4.0)
  - B ~ N(8.0, 1.0)
  - C ~ N(12.0, 2.0)

### 感度解析の計算方法

有限差分法を使用して勾配を計算：

```
∂E[MAX]/∂μ_B ≈ (E[MAX(μ_B+δ)] - E[MAX(μ_B-δ)]) / (2δ)
```

Common Random Number法を使用することで、統計的な誤差を最小化しています。

## 結果

### モンテカルロ結果（厳密解）

```
E[MAX(MAX(A,B), MAX(A,C))] = 12.28708077
Var[MAX(MAX(A,B), MAX(A,C))] = 1.74166768

Sensitivity Analysis:
  ∂E[MAX]/∂μ_A = 0.20543935  [POSITIVE]
  ∂E[MAX]/∂μ_B = 0.00421200  [POSITIVE]
  ∂E[MAX]/∂μ_C = 0.79034866  [POSITIVE]
  Sum = 1.00000000
```

### Clark近似の結果（実装）

```
  grad_A = 0.26094127  [POSITIVE]
  grad_B = -0.00471593 [NEGATIVE!]
  grad_C = 0.74377466  [POSITIVE]
  Sum = 1.00000000
```

## 比較

| 勾配 | モンテカルロ（厳密解） | Clark近似（実装） | 差分 |
|------|----------------------|------------------|------|
| grad_A | 0.20543935 | 0.26094127 | -0.05550192 |
| grad_B | **0.00421200** (正) | **-0.00471593** (負) | **0.00892793** |
| grad_C | 0.79034866 | 0.74377466 | 0.04657400 |

## 重要な発見

### 1. grad_B の符号が反転している

- **モンテカルロ法（厳密解）**: `grad_B = 0.00421200` (正)
- **Clark近似（実装）**: `grad_B = -0.00471593` (負)
- **差分**: 0.00892793（符号が反転）

### 2. 単調性の保証

- **モンテカルロ法**: すべての勾配が正 → 単調性が保証されている
- **Clark近似**: grad_B が負 → 単調性が破られている

### 3. 理論との整合性

- **MAX関数の単調性**: 入力の増加は出力の増加（または不変）を意味する
- **モンテカルロ法**: この性質が保証されている
- **Clark近似**: この性質が破られている

## 結論

**Clark近似の実装にバグがある可能性が高い**

理由：
1. モンテカルロ法（厳密解）では grad_B は正であることが確認された
2. Clark近似では grad_B は負（符号が反転）
3. これは「Clark公式の適用限界」ではなく、実装のバグである可能性が高い

特に、grad_B の符号が反転しているのは重大な問題です。これは、多段MAX演算での近似誤差が大きすぎるか、実装の計算方法が間違っていることを示唆しています。

## Clark公式の適用条件の再確認

### Clark公式の前提条件

Clark公式は、**入力が正規分布であるという仮定の下での厳密解**です。

### 単段MAX演算

- **入力**: A, B は正規分布
- **Clark公式の仮定が成立** → 厳密解
- **単調性が保証される** → `∂E[MAX(A,B)]/∂μ_A ≥ 0`

### 多段MAX演算

- **第1段階**: MAX(A,B), MAX(A,C)
  - 入力は正規分布 → Clark公式の仮定が成立
- **第2段階**: MAX(MAX(A,B), MAX(A,C))
  - **問題**: MAX(A,B) と MAX(A,C) は正規分布ではない
  - **Clark公式の仮定が成立しない** → 近似解になる
  - **近似誤差が発生する可能性**

### しかし、モンテカルロ法の結果から

モンテカルロ法（厳密解）では grad_B が正であることが確認されたため、**理論的には grad_B は正であるべき**です。

したがって、Clark近似の実装に問題がある可能性が高いです。

## 検証コード

- `example/monte_carlo_verification.cpp`: モンテカルロ法による検証コード
- Common Random Number法を使用して有限差分法で勾配を計算
- 理論的には厳密解を求められる（サンプル数が十分大きい場合）

## 次のステップ

1. **実装の修正を最優先で実施**
   - モンテカルロ法で grad_B が正であることが確認された
   - Clark近似の実装にバグがある可能性が高い
   - 勾配の累積ロジック、特にMAXの式木構造を再検討

2. **Clark近似の適用方法の検証**
   - 多段MAX演算でのClark近似の適用方法を再検証
   - 中間結果が正規分布ではないことによる近似誤差を評価

3. **修正案の検討**
   - モンテカルロ法の結果を基準として、Clark近似の実装を修正
   - 勾配が常に非負になることを保証する実装を検討

