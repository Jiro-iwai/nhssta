# Issue #242: 負の勾配の根本原因調査サマリー

## 調査結果

### 1. 負のupstream勾配の発生源

デバッグログから、以下の流れで負の勾配が発生していることが確認されました：

```
Node[7] (op=MUL)
  Left: Node[2] (value=-1)  ← 負の値（-(μ/σ)の計算結果）
  Right: Node[6] (value=0.666667)
  Propagating to right: -0.142927  ← 負の勾配！
```

**原因**: MUL演算では`right_grad = upstream * left`です。
- `upstream = 0.142927` (正)
- `left = -1` (負)
- `right_grad = 0.142927 × (-1) = -0.142927` (負)

これは**数学的に正しい動作**です。

### 2. 負の勾配の連鎖

負の勾配が`Node[6]`に伝播し、さらに負の勾配を生成：

```
Node[6] (op=MUL)
  Upstream gradient: -0.142927  ← 負のupstream
  Propagating to left: -0.1167  ← 負の勾配
  Propagating to right: -0.1167  ← 負の勾配
```

最終的に、CUSTOM_FUNCTION（MAX0、MeanMaxなど）に負の勾配が伝播：

```
arg[0]: upstream=-11.199 × grad[0]=0.792892 = contrib=-8.87958
  ⚠️  NEGATIVE GRADIENT CONTRIBUTION!
```

### 3. MAX0の式木構造

MAX0の実装：
```cpp
E[MAX0] = μ + σ × MeanMax(-μ/σ)
```

ここで、`a = -(μ/σ)`の計算で：
- `Node[2] (value=-1)` - これは`-`演算の結果
- MUL演算で、この負の値が右側の勾配を負にする

## 根本原因の仮説

### 仮説: 多段MAX演算での勾配の累積方法

1. **MAX0の理論的勾配は常に非負**
   - `∂E[MAX0]/∂μ = Φ(μ/σ) ∈ [0, 1]`
   - これは数学的に証明されています

2. **しかし、多段MAX演算では負の勾配が発生**
   - 共有入力（A）が複数のパスを通る
   - 各パスから勾配が累積される
   - 負の勾配が累積され、最終的なmean gradientが負になる

3. **問題の本質**
   - MUL演算での負の勾配は数学的に正しい
   - しかし、最終的なmean gradientが負になるのは問題
   - これは、**多段MAX演算での勾配の累積方法に問題がある**可能性を示唆

## 検証が必要な点

1. **MAX0の勾配計算は正しいか？**
   - `∂E[MAX0]/∂μ = Φ(μ/σ) ∈ [0, 1]`が保証されているか
   - `sigma`の勾配が負になることがあるか

2. **多段MAX演算での勾配の累積は正しいか？**
   - 負の勾配が累積されることがあるか
   - 最終的なmean gradientが非負であるべきか

3. **実装の詳細な検証**
   - なぜ`upstream=-11.199`が発生するのか
   - どのノードで負の値が発生しているのか
   - 負の勾配がどのように伝播しているのか

## 次のステップ

1. **MAX0の実装の詳細な検証**
   - `sigma = sqrt(variance)`の勾配計算を検証
   - 負の勾配が発生する条件を特定

2. **多段MAX演算での勾配計算の見直し**
   - 負の勾配が累積されないようにする
   - 最終的なmean gradientが非負になることを保証する

3. **修正案の検討**
   - sigmaの勾配計算の見直し
   - 多段MAX演算での勾配計算の見直し

## 結論

負の勾配の発生は、**MUL演算での負の値による数学的に正しい動作**です。しかし、**最終的なmean gradientが負になるのは問題**です。

これは、**多段MAX演算での勾配の累積方法に問題がある**可能性を示唆しています。修正には、MAX0の実装の詳細な検証と、多段MAX演算での勾配計算の見直しが必要です。

