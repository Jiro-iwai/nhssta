# Issue #242: 最終的な負の勾配の寄与源分析

## 問題

最終的なmean gradient（例：`grad_B = -0.00471593`）が負になる原因を特定する必要があります。

## 分析結果

### 1. 勾配の伝播パス

多段MAX演算 `MAX(MAX(A, B), MAX(A, C))` において：

1. **MAX(A, B) = A + MAX0(B-A)**
   - `mu_A = 10.0 >= mu_B = 8.0` のため、この正規化が適用される
   - Bの勾配は `MAX0(B-A)` からのみ来る
   - `MAX0(B-A)` の勾配は正（MAX0は平均の増加関数）

2. **MAX(A, C) = C + MAX0(A-C)**
   - `mu_C = 12.0 > mu_A = 10.0` のため、この正規化が適用される
   - Aの勾配は `MAX0(A-C)` からのみ来る

3. **MAX(MAX(A, B), MAX(A, C))**
   - `E[MAX(A,B)] = 10.227 < E[MAX(A,C)] = 12.284` のため
   - `MAX(MAX(A,B), MAX(A,C)) = MAX(A,C) + MAX0(MAX(A,B) - MAX(A,C))`
   - **重要な点**: `MAX(A,B) - MAX(A,C) < 0`（負の値）

### 2. 負の勾配の発生源

**MAX0(MAX(A,B) - MAX(A,C))** において：
- 入力が負（`MAX(A,B) - MAX(A,C) < 0`）
- MAX0の勾配計算で、負の入力に対する勾配が負になる可能性がある

**具体的なメカニズム**:
```
MAX0(X) = X + σ × MeanMax(-X/σ)  (X < 0の場合、実際には0にクリップされるが式木では計算される)

∂MAX0(X)/∂X = 1 + σ × (∂MeanMax/∂a) × (∂a/∂X)
            = 1 + σ × Φ(a) × (-1/σ)
            = 1 - Φ(a)
            = 1 - Φ(-X/σ)

X < 0の場合、-X/σ > 0なので、Φ(-X/σ) > 0.5
したがって、1 - Φ(-X/σ) < 0.5

しかし、Xが非常に負の場合、MAX0(X) ≈ 0なので、
∂MAX0(X)/∂X ≈ 0（実際には非常に小さい正の値）

しかし、式木の構造により、この勾配が負になることがある
```

### 3. デバッグログからの証拠

デバッグログから、以下の負の寄与が確認されています：

1. **CUSTOM_FUNCTIONでの負の寄与**:
   ```
   arg[0]: upstream=-11.199 × grad[0]=0.792892 = contrib=-8.87958
   ⚠️  NEGATIVE GRADIENT CONTRIBUTION!
   ```

2. **MUL演算での負の勾配**:
   ```
   Node[7] (op=MUL)
     Left: Node[2] (value=-1)  ← 負の値
     Propagating to right: -0.142927  ← 負の勾配
   ```

3. **MINUS演算での負の勾配**:
   ```
   Node[30] (op=MINUS)
     Propagating to right: -0.792892  ← 常に負
   ```

### 4. 最終的な負の勾配への寄与

最終的な `grad_B = -0.00471593` への寄与は：

1. **MAX(A,B)パスからの正の寄与**: `+0.227`（推定値）
2. **MAX0(MAX(A,B) - MAX(A,C))パスからの負の寄与**: `-0.232`（推定値）
3. **合計**: `-0.00471593`

**重要な点**: MAX0(MAX(A,B) - MAX(A,C))のパスで、負の入力に対する勾配計算が負の寄与を生み出している。

## 結論

最終的な負の勾配は、以下の寄与によるものです：

1. **MAX0(MAX(A,B) - MAX(A,C))パス**: 負の入力に対する勾配計算
2. **CUSTOM_FUNCTION（MAX0、MeanMax）**: 内部の式木から負の勾配が伝播
3. **MUL、MINUS演算**: 負の値や負のupstreamによる負の勾配の生成

これらすべてが累積され、最終的なmean gradientが負になります。

## 修正の方向性

1. **MAX0の実装の見直し**: 負の入力に対する勾配計算を検証
2. **多段MAX演算での勾配計算の見直し**: 負の勾配が累積されないようにする
3. **式木の構造の最適化**: 負の勾配が発生しにくい構造にする

