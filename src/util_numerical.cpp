// -*- c++ -*-
// Author: IWAI Jiro

#include "util_numerical.hpp"

#include <algorithm>
#include <cctype>
#include <cmath>
#include <ctime>

namespace RandomVariable {

/* ------------ table ------------- */

/* mean_max_tab -5 5 0.05 */
// NOLINTNEXTLINE(cppcoreguidelines-avoid-c-arrays,modernize-avoid-c-arrays)
double mean_max_tab[] = {4.95574e-08, 6.18037e-08, 9.49191e-08,
                         1.28034e-07, 1.6115e-07,  1.94265e-07,
                         2.27381e-07, 3.23718e-07, 4.51588e-07,
                         5.79459e-07, 7.0733e-07,  8.352e-07,
                         1.01713e-06, 1.47612e-06, 1.93511e-06,
                         2.3941e-06,  2.85309e-06, 3.31208e-06,
                         4.47729e-06, 6.0092e-06,  7.54112e-06,
                         9.07303e-06, 1.06049e-05, 1.26274e-05,
                         1.73828e-05, 2.21382e-05, 2.68936e-05,
                         3.1649e-05,  3.64044e-05, 4.69534e-05,
                         6.06879e-05, 7.44225e-05, 8.8157e-05,
                         0.000101892, 0.000118812, 0.000155735,
                         0.000192658, 0.000229581, 0.000266505,
                         0.000303428, 0.000375257, 0.000467697,
                         0.000560137, 0.000652577, 0.000745017,
                         0.000852167, 0.00106782,  0.00128348,
                         0.00149913,  0.00171479,  0.00193045,
                         0.00230057,  0.00276973,  0.00323889,
                         0.00370805,  0.00417721,  0.00469409,
                         0.00564671,  0.00659933,  0.00755194,
                         0.00850456,  0.00945718,  0.0109119,
                         0.0127192,   0.0145265,   0.0163337,
                         0.018141,    0.0200545,   0.0232621,
                         0.0264698,   0.0296774,   0.032885,
                         0.0360926,   0.0404995,   0.0458339,
                         0.0511683,   0.0565027,   0.0618371,
                         0.0673257,   0.0756539,   0.0839821,
                         0.0923103,   0.100638,    0.108967,
                         0.1194,      0.131634,    0.143868,
                         0.156102,    0.168336,    0.180693,
                         0.19765,     0.214608,    0.231565,
                         0.248522,    0.26548,     0.285153,
                         0.307403,    0.329654,    0.351905,
                         0.374156,    0.396406,    0.424156,
                         0.451905,    0.479654,    0.507403,
                         0.535153,    0.56548,     0.598522,
                         0.631565,    0.664608,    0.69765,
                         0.730693,    0.768336,    0.806102,
                         0.843868,    0.881634,    0.9194,
                         0.958967,    1.00064,     1.04231,
                         1.08398,     1.12565,     1.16733,
                         1.21184,     1.2565,      1.30117,
                         1.34583,     1.3905,      1.43609,
                         1.48289,     1.52968,     1.57647,
                         1.62326,     1.67005,     1.71814,
                         1.76633,     1.81453,     1.86272,
                         1.91091,     1.95946,     2.0085,
                         2.05755,     2.1066,      2.15565,
                         2.20469,     2.25418,     2.30371,
                         2.35324,     2.40277,     2.4523,
                         2.50193,     2.55171,     2.6015,
                         2.65128,     2.70107,     2.75085,
                         2.80075,     2.85065,     2.90056,
                         2.95047,     3.00038,     3.0503,
                         3.10027,     3.15023,     3.20019,
                         3.25016,     3.30012,     3.3501,
                         3.40009,     3.45007,     3.50006,
                         3.55005,     3.60004,     3.65003,
                         3.70003,     3.75002,     3.80002,
                         3.85001,     3.90001,     3.95001,
                         4.00001,     4.05001,     4.1,
                         4.15,        4.2,         4.25,
                         4.3,         4.35,        4.4,
                         4.45,        4.5,         4.55,
                         4.6,         4.65,        4.7,
                         4.75,        4.8,         4.85,
                         4.9,         4.95,        5};

/* mean_x_max_tab -5 5 0.05 */
// NOLINTNEXTLINE(cppcoreguidelines-avoid-c-arrays,modernize-avoid-c-arrays)
double mean_x_max_tab[] = {
    1,           1,           1,           0.999999,    0.999999,    0.999999,    0.999999,
    0.999998,    0.999998,    0.999997,    0.999997,    0.999996,    0.999995,    0.999993,
    0.999991,    0.999989,    0.999987,    0.999985,    0.99998,     0.999973,    0.999967,
    0.99996,     0.999954,    0.999945,    0.999926,    0.999907,    0.999889,    0.99987,
    0.999851,    0.999811,    0.99976,     0.999709,    0.999658,    0.999607,    0.999545,
    0.999417,    0.999289,    0.999162,    0.999034,    0.998906,    0.998672,    0.998376,
    0.99808,     0.997784,    0.997488,    0.997151,    0.996516,    0.99588,     0.995244,
    0.994609,    0.993973,    0.992954,    0.99169,     0.990425,    0.989161,    0.987896,
    0.986527,    0.984196,    0.981866,    0.979535,    0.977205,    0.974874,    0.971575,
    0.967596,    0.963616,    0.959637,    0.955658,    0.951502,    0.945207,    0.938912,
    0.932616,    0.926321,    0.920026,    0.912078,    0.902851,    0.893625,    0.884398,
    0.875172,    0.865776,    0.853248,    0.840721,    0.828194,    0.815666,    0.803139,
    0.788871,    0.773114,    0.757357,    0.7416,      0.725842,    0.710017,    0.691656,
    0.673295,    0.654934,    0.636573,    0.618211,    0.599102,    0.579281,    0.559461,
    0.539641,    0.51982,     0.5,         0.48018,     0.460359,    0.440539,    0.420719,
    0.400898,    0.381789,    0.363427,    0.345066,    0.326705,    0.308344,    0.289983,
    0.274158,    0.2584,      0.242643,    0.226886,    0.211129,    0.196861,    0.184334,
    0.171806,    0.159279,    0.146752,    0.134224,    0.124828,    0.115602,    0.106375,
    0.0971487,   0.0879222,   0.0799742,   0.0736789,   0.0673836,   0.0610883,   0.054793,
    0.0484977,   0.0443425,   0.0403631,   0.0363837,   0.0324043,   0.0284249,   0.0251256,
    0.0227952,   0.0204647,   0.0181343,   0.0158038,   0.0134733,   0.0121036,   0.0108392,
    0.00957469,  0.00831022,  0.00704576,  0.00602693,  0.00539127,  0.00475561,  0.00411995,
    0.00348429,  0.00284863,  0.002512,    0.00221592,  0.00191984,  0.00162375,  0.00132767,
    0.00109407,  0.00096628,  0.000838493, 0.000710706, 0.000582919, 0.000455132, 0.000393492,
    0.000342386, 0.000291281, 0.000240176, 0.00018907,  0.000149377, 0.000130437, 0.000111497,
    9.25578e-05, 7.36181e-05, 5.46784e-05, 4.62813e-05, 3.97766e-05, 3.32719e-05, 2.67672e-05,
    2.02625e-05, 1.52733e-05, 1.32029e-05, 1.11325e-05, 9.06206e-06, 6.99164e-06, 4.92122e-06,
    4.07216e-06, 3.46137e-06, 2.85059e-06, 2.2398e-06,  1.62902e-06, 1.16592e-06, 9.98908e-07,
    8.31896e-07, 6.64885e-07, 4.97874e-07, 3.30862e-07, 2.6733e-07};

/* mean_max^2_tab -5 5 0.05 */
// NOLINTNEXTLINE(cppcoreguidelines-avoid-c-arrays,modernize-avoid-c-arrays)
double mean_max2_tab[] = {
    0.999999, 0.999999, 0.999999, 0.999999, 0.999998, 0.999998, 0.999998, 0.999997, 0.999996,
    0.999995, 0.999993, 0.999992, 0.999991, 0.999987, 0.999983, 0.999979, 0.999975, 0.999971,
    0.999961, 0.999949, 0.999937, 0.999924, 0.999912, 0.999897, 0.99986,  0.999824, 0.999789,
    0.999754, 0.99972,  0.999644, 0.999547, 0.999452, 0.999358, 0.999265, 0.999153, 0.998911,
    0.998673, 0.998438, 0.998208, 0.99798,  0.997547, 0.996997, 0.996456, 0.995924, 0.995402,
    0.994808, 0.993633, 0.992479, 0.991347, 0.990236, 0.989147, 0.987318, 0.985042, 0.982814,
    0.980632, 0.978498, 0.9762,   0.972056, 0.968007, 0.964054, 0.960196, 0.956433, 0.950842,
    0.944065, 0.937469, 0.931053, 0.924818, 0.918412, 0.907988, 0.897884, 0.8881,   0.878638,
    0.869496, 0.857403, 0.843267, 0.829665, 0.816595, 0.804059, 0.791717, 0.773812, 0.756739,
    0.740499, 0.725092, 0.710518, 0.693352, 0.674389, 0.656649, 0.640133, 0.624841, 0.610636,
    0.592831, 0.576721, 0.562308, 0.54959,  0.538568, 0.527813, 0.517801, 0.510013, 0.50445,
    0.501113, 0.5,      0.501387, 0.50555,  0.512487, 0.522199, 0.534687, 0.551432, 0.57291,
    0.597692, 0.625779, 0.657169, 0.691864, 0.735159, 0.782367, 0.833351, 0.888111, 0.946648,
    1.01198,  1.08491,  1.162,    1.24326,  1.32869,  1.41828,  1.51844,  1.6234,   1.73284,
    1.84673,  1.9651,   2.0905,   2.22386,  2.3619,   2.50462,  2.65201,  2.80409,  2.96518,
    3.13145,  3.30253,  3.47843,  3.65916,  3.84607,  4.0398,   4.23845,  4.44199,  4.65044,
    4.8638,   5.084,    5.30937,  5.53969,  5.77496,  6.01518,  6.26085,  6.51226,  6.76865,
    7.03002,  7.29637,  7.56769,  7.8446,   8.12658,  8.41354,  8.7055,   9.00245,  9.30452,
    9.61179,  9.92406,  10.2413,  10.5636,  10.8908,  11.2232,  11.5606,  11.903,   12.2505,
    12.6029,  12.9603,  13.3227,  13.6902,  14.0627,  14.4401,  14.8226,  15.2101,  15.6026,
    16.0001,  16.4026,  16.81,    17.2225,  17.64,    18.0625,  18.49,    18.9225,  19.36,
    19.8025,  20.25,    20.7025,  21.16,    21.6225,  22.09,    22.5625,  23.04,    23.5225,
    24.01,    24.5025,  25};

/* ------------------------------- */

static constexpr double kCut = 5.0;
static constexpr double kDiv = kCut / 100.0;
static constexpr int TAB_SIZE = 201;  // Array size: -5 to 5 with 0.05 step

static void set_range(double a, int& lower, int& upper) {
    double len = (a + kCut) / kDiv;
    lower = int(floor(len));
    upper = int(ceil(len));
    // Clamp to valid array bounds
    lower = std::max(lower, 0);
    upper = std::min(upper, TAB_SIZE - 1);
    lower = std::min(lower, TAB_SIZE - 1);
}

double MeanMax(double a) {
    if (a < -kCut) {
        return 0.0;
    }
    if (kCut < a) {
        return a;
    }
    int l = 0;
    int u = 0;
    set_range(a, l, u);
    double r = (mean_max_tab[l] + mean_max_tab[u]) * 0.5;
    return r;
}

double MeanPhiMax(double a) {
    if (a < -kCut) {
        return 1.0;
    }
    if (kCut < a) {
        return 0.0;
    }
    int l = 0;
    int u = 0;
    set_range(a, l, u);
    double r = (mean_x_max_tab[l] + mean_x_max_tab[u]) * 0.5;
    return r;
}

double MeanMax2(double a) {
    if (a < -kCut) {
        return 1.0;
    }
    if (kCut < a) {
        return a * a;
    }
    int l = 0;
    int u = 0;
    set_range(a, l, u);
    double r = (mean_max2_tab[l] + mean_max2_tab[u]) * 0.5;
    return r;
}

// ============================================================================
// Standard normal distribution functions for Cov(max, max) calculation
// ============================================================================

static constexpr double SQRT_2PI = 2.5066282746310005024;  // √(2π)
static constexpr double SQRT_2 = 1.4142135623730950488;    // √2

double normal_pdf(double x) {
    // φ(x) = exp(-x²/2) / √(2π)
    return std::exp(-0.5 * x * x) / SQRT_2PI;
}

double normal_cdf(double x) {
    // Φ(x) = 0.5 * erfc(-x/√2)
    return 0.5 * std::erfc(-x / SQRT_2);
}

double expected_positive_part(double mu, double sigma) {
    // E[max(0, D)] where D ~ N(μ, σ²)
    // Formula: E[max(0,D)] = σφ(μ/σ) + μΦ(μ/σ)
    double t = mu / sigma;
    return (sigma * normal_pdf(t)) + (mu * normal_cdf(t));
}

// ============================================================================
// Gauss-Hermite 10-point quadrature for standard normal integration
// ∫_{-∞}^{∞} φ(z) f(z) dz ≒ Σ wphi[i] * f(zphi[i])
//
// Conversion from standard Gauss-Hermite (with exp(-x²) weight):
//   z = √2 * x_GH, w_phi = w_GH / √π
// ============================================================================

static constexpr int GH_N = 10;

// Converted nodes and weights for standard normal integration
// Original Gauss-Hermite nodes x_i for exp(-x²) weight are converted to
// z_i = √2 * x_i for N(0,1) integration, and weights w_i are divided by √π
// NOLINTNEXTLINE(cppcoreguidelines-avoid-c-arrays,modernize-avoid-c-arrays)
static const double zphi[GH_N] = {
    -4.859462828332311,
    -3.581823483551719,
    -2.484325841638954,
    -1.465989094391158,
    -0.484935721616248,
     0.484935721616248,
     1.465989094391158,
     2.484325841638954,
     3.581823483551719,
     4.859462828332311
};

// NOLINTNEXTLINE(cppcoreguidelines-avoid-c-arrays,modernize-avoid-c-arrays)
static const double wphi[GH_N] = {
    4.31065263071830e-06,
    7.58070934312218e-04,
    1.91115805007703e-02,
    1.35483702980267e-01,
    3.44642334932019e-01,
    3.44642334932019e-01,
    1.35483702980267e-01,
    1.91115805007703e-02,
    7.58070934312218e-04,
    4.31065263071830e-06
};

// Helper: Clamp value to [min, max]
static double clamp(double val, double min_val, double max_val) {
    if (val < min_val) {
        return min_val;
    }
    if (val > max_val) {
        return max_val;
    }
    return val;
}

double expected_prod_pos(double mu0, double sigma0,
                         double mu1, double sigma1,
                         double rho) {
    // E[D0⁺ D1⁺] where D0, D1 are bivariate normal with correlation ρ
    //
    // Decomposition:
    //   D0 = μ0 + σ0 * Z
    //   D1 = μ1 + σ1 * (ρ*Z + √(1-ρ²)*Z1)
    // where Z, Z1 are independent standard normals.
    //
    // E[D0⁺ D1⁺] = E_Z[ (μ0 + σ0*Z)⁺ * E[D1⁺ | Z] ]
    //
    // Conditional distribution: D1|Z=z ~ N(m(z), s²)
    //   m(z) = μ1 + ρ*σ1*z
    //   s = σ1 * √(1-ρ²)
    //
    // E[D1⁺ | Z=z] = s*φ(m(z)/s) + m(z)*Φ(m(z)/s)

    // Clamp rho to [-1, 1] for numerical stability
    rho = clamp(rho, -1.0, 1.0);

    double one_minus_rho2 = std::max(0.0, 1.0 - (rho * rho));
    double s1_cond = sigma1 * std::sqrt(one_minus_rho2);

    double sum = 0.0;
    for (int i = 0; i < GH_N; ++i) {
        double z = zphi[i];
        double w = wphi[i];

        // D0 value at this quadrature point
        double d0 = mu0 + (sigma0 * z);

        // D0⁺ = max(0, d0)
        if (d0 <= 0.0) {
            // D0⁺ = 0, so contribution is 0
            continue;
        }
        double D0plus = d0;

        // Conditional mean of D1 given Z=z
        double m1z = mu1 + (rho * sigma1 * z);

        // E[D1⁺ | Z=z]
        double E_D1pos_givenZ = 0.0;
        if (s1_cond > 1e-12) {
            // Normal case: use expected_positive_part formula
            double t = m1z / s1_cond;
            E_D1pos_givenZ = (s1_cond * normal_pdf(t)) + (m1z * normal_cdf(t));
        } else {
            // ρ = ±1 limit: D1 is deterministic given Z
            E_D1pos_givenZ = std::max(0.0, m1z);
        }

        sum += w * D0plus * E_D1pos_givenZ;
    }

    return sum;
}

}  // namespace RandomVariable
